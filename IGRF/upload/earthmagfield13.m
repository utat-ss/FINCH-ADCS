%1st Gaussian Coeff. [T]
g1_0 = -29404.8 *1e-9;
g1_1 = -1450.9 *1e-9;
g2_0 = -2499.6 *1e-9;
g2_1 = 1677 *1e-9;
g2_2 = 1672 *1e-9;
g3_0 = 1363.2 *1e-9;
g3_1 = -2381.2 *1e-9;
g3_2 = 1236.2 *1e-9;
g3_3 = 525.7 *1e-9;
g4_0 = 903 *1e-9;
g4_1 = 809.5 *1e-9;
g4_2 = 86.3 *1e-9;
g4_3 = -309.4 *1e-9;
g4_4 = 48 *1e-9;
g5_0 = -234.3 *1e-9;
g5_1 = 363.2 *1e-9;
g5_2 = 187.8 *1e-9;
g5_3 = -140.7 *1e-9;
g5_4 = -151.2 *1e-9;
g5_5 = 13.5 *1e-9;
g6_0 = 66 *1e-9;
g6_1 = 65.5 *1e-9;
g6_2 = 72.9 *1e-9;
g6_3 = -121.5 *1e-9;
g6_4 = -36.2 *1e-9;
g6_5 = 13.5 *1e-9;
g6_6 = -64.7 *1e-9;
g7_0 = 80.6 *1e-9;
g7_1 = -76.7 *1e-9;
g7_2 = -8.2 *1e-9;
g7_3 = 56.5 *1e-9;
g7_4 = 15.8 *1e-9;
g7_5 = 6.4 *1e-9;
g7_6 = -7.2 *1e-9;
g7_7 = 9.8 *1e-9;
g8_0 = 23.7 *1e-9;
g8_1 = 9.7 *1e-9;
g8_2 = -17.6 *1e-9;
g8_3 = -0.5 *1e-9;
g8_4 = -21.1 *1e-9;
g8_5 = 15.3 *1e-9;
g8_6 = 13.7 *1e-9;
g8_7 = -16.5 *1e-9;
g8_8 = -0.3 *1e-9;
g9_0 = 5 *1e-9;
g9_1 = 8.4 *1e-9;
g9_2 = 2.9 *1e-9;
g9_3 = -1.5 *1e-9;
g9_4 = -1.1 *1e-9;
g9_5 = -13.2 *1e-9;
g9_6 = 1.1 *1e-9;
g9_7 = 8.8 *1e-9;
g9_8 = -9.3 *1e-9;
g9_9 = -11.9 *1e-9;
g10_0 = -1.9 *1e-9;
g10_1 = -6.2 *1e-9;
g10_2 = -0.1 *1e-9;
g10_3 = 1.7 *1e-9;
g10_4 = -0.9 *1e-9;
g10_5 = 0.7 *1e-9;
g10_6 = -0.9 *1e-9;
g10_7 = 1.9 *1e-9;
g10_8 = 1.4 *1e-9;
g10_9 = -2.4 *1e-9;
g10_10 = -3.8 *1e-9;
g11_0 = 3 *1e-9;
g11_1 = -1.4 *1e-9;
g11_2 = -2.5 *1e-9;
g11_3 = 2.3 *1e-9;
g11_4 = -0.9 *1e-9;
g11_5 = 0.3 *1e-9;
g11_6 = -0.7 *1e-9;
g11_7 = -0.1 *1e-9;
g11_8 = 1.4 *1e-9;
g11_9 = -0.6 *1e-9;
g11_10 = 0.2 *1e-9;
g11_11 = 3.1 *1e-9;
g12_0 = -2 *1e-9;
g12_1 = -0.1 *1e-9;
g12_2 = 0.5 *1e-9;
g12_3 = 1.3 *1e-9;
g12_4 = -1.2 *1e-9;
g12_5 = 0.7 *1e-9;
g12_6 = 0.3 *1e-9;
g12_7 = 0.5 *1e-9;
g12_8 = -0.3 *1e-9;
g12_9 = -0.5 *1e-9;
g12_10 = 0.1 *1e-9;
g12_11 = -1.1 *1e-9;
g12_12 = -0.3 *1e-9;
g13_0 = 0.1 *1e-9;
g13_1 = -0.9 *1e-9;
g13_2 = 0.5 *1e-9;
g13_3 = 0.7 *1e-9;
g13_4 = -0.3 *1e-9;
g13_5 = 0.8 *1e-9;
g13_6 = 0 *1e-9;
g13_7 = 0.8 *1e-9;
g13_8 = 0 *1e-9;
g13_9 = 0.4 *1e-9;
g13_10 = 0.1 *1e-9;
g13_11 = 0.5 *1e-9;
g13_12 = -0.5 *1e-9;
g13_13 = -0.4 *1e-9;
g = [g1_0 g2_0 g3_0 g4_0 g5_0 g6_0 g7_0 g8_0 g9_0 g10_0  g11_0  g12_0  g13_0;
     g1_1 g2_1 g3_1 g4_1 g5_1 g6_1 g7_1 g8_1 g9_1 g10_1  g11_1  g12_1  g13_1;
       0  g2_2 g3_2 g4_2 g5_2 g6_2 g7_2 g8_2 g9_2 g10_2  g11_2  g12_2  g13_2;
       0    0  g3_3 g4_3 g5_3 g6_3 g7_3 g8_3 g9_3 g10_3  g11_3  g12_3  g13_3;
       0    0    0  g4_4 g5_4 g6_4 g7_4 g8_4 g9_4 g10_4  g11_4  g12_4  g13_4;
       0    0    0    0  g5_5 g6_5 g7_5 g8_5 g9_5 g10_5  g11_5  g12_5  g13_5;
       0    0    0    0    0  g6_6 g7_6 g8_6 g9_6 g10_6  g11_6  g12_6  g13_6;
       0    0    0    0    0    0  g7_7 g8_7 g9_7 g10_7  g11_7  g12_7  g13_7;
       0    0    0    0    0    0    0  g8_8 g9_8 g10_8  g11_8  g12_8  g13_8;
       0    0    0    0    0    0    0    0  g9_9 g10_9  g11_9  g12_9  g13_9;
       0    0    0    0    0    0    0    0    0  g10_10 g11_10 g12_10 g13_10;
       0    0    0    0    0    0    0    0    0    0    g11_11 g12_11 g13_11;
       0    0    0    0    0    0    0    0    0    0       0   g12_12 g13_12;
       0    0    0    0    0    0    0    0    0    0       0      0   g13_13];

%2nd Gaussian Coeff [T]
h1_0 = 0 *1e-9;
h1_1 = 4652.5 *1e-9;
h2_0 = 0 *1e-9;
h2_1 = -2991.6 *1e-9;
h2_2 = -734.6 *1e-9;
h3_0 = 0 *1e-9;
h3_1 = -82.1 *1e-9;
h3_2 = 241.9 *1e-9;
h3_3 = -543.4 *1e-9;
h4_0 = 0 *1e-9;
h4_1 = 281.9 *1e-9;
h4_2 = -158.4 *1e-9;
h4_3 = 199.7 *1e-9;
h4_4 = -349.7 *1e-9;
h5_0 = 0 *1e-9;
h5_1 = 47.7 *1e-9;
h5_2 = 208.3 *1e-9;
h5_3 = -121.2 *1e-9;
h5_4 = 32.3 *1e-9;
h5_5 = 98.9 *1e-9;
h6_0 = 0 *1e-9;
h6_1 = -19.1 *1e-9;
h6_2 = 25.1 *1e-9;
h6_3 = 52.8 *1e-9;
h6_4 = -64.5 *1e-9;
h6_5 = 8.9 *1e-9;
h6_6 = 68.1 *1e-9;
h7_0 = 0 *1e-9;
h7_1 = -51.5 *1e-9;
h7_2 = -16.9 *1e-9;
h7_3 = 2.2 *1e-9;
h7_4 = 23.5 *1e-9;
h7_5 = -2.2 *1e-9;
h7_6 = -27.2 *1e-9;
h7_7 = -1.8 *1e-9;
h8_0 = 0 *1e-9;
h8_1 = 8.4 *1e-9;
h8_2 = -15.3 *1e-9;
h8_3 = 12.8 *1e-9;
h8_4 = -11.7 *1e-9;
h8_5 = 14.9 *1e-9;
h8_6 = 3.6 *1e-9;
h8_7 = -6.9 *1e-9;
h8_8 = 2.8 *1e-9;
h9_0 = 0 *1e-9;
h9_1 = -23.4 *1e-9;
h9_2 = 11 *1e-9;
h9_3 = 9.8 *1e-9;
h9_4 = -5.1 *1e-9;
h9_5 = -6.3 *1e-9;
h9_6 = 7.8 *1e-9;
h9_7 = 0.4 *1e-9;
h9_8 = -1.4 *1e-9;
h9_9 = 9.6 *1e-9;
h10_0 = 0 *1e-9;
h10_1 = 3.4 *1e-9;
h10_2 = -0.2 *1e-9;
h10_3 = 3.6 *1e-9;
h10_4 = 4.8 *1e-9;
h10_5 = -8.6 *1e-9;
h10_6 = -0.1 *1e-9;
h10_7 = -4.3 *1e-9;
h10_8 = -3.4 *1e-9;
h10_9 = -0.1 *1e-9;
h10_10 = -8.8 *1e-9;
h11_0 = 0 *1e-9;
h11_1 = 0 *1e-9;
h11_2 = 2.5 *1e-9;
h11_3 = -0.6 *1e-9;
h11_4 = -0.4 *1e-9;
h11_5 = 0.6 *1e-9;
h11_6 = -0.2 *1e-9;
h11_7 = -1.7 *1e-9;
h11_8 = -1.6 *1e-9;
h11_9 = -3 *1e-9;
h11_10 = -2 *1e-9;
h11_11 = -2.6 *1e-9;
h12_0 = 0 *1e-9;
h12_1 = -1.2 *1e-9;
h12_2 = 0.5 *1e-9;
h12_3 = 1.4 *1e-9;
h12_4 = -1.8 *1e-9;
h12_5 = 0.1 *1e-9;
h12_6 = 0.8 *1e-9;
h12_7 = -0.2 *1e-9;
h12_8 = 0.6 *1e-9;
h12_9 = 0.2 *1e-9;
h12_10 = -0.9 *1e-9;
h12_11 = 0 *1e-9;
h12_12 = 0.5 *1e-9;
h13_0 = 0 *1e-9;
h13_1 = -0.9 *1e-9;
h13_2 = 0.6 *1e-9;
h13_3 = 1.4 *1e-9;
h13_4 = -0.4 *1e-9;
h13_5 = -1.3 *1e-9;
h13_6 = -0.1 *1e-9;
h13_7 = 0.3 *1e-9;
h13_8 = -0.1 *1e-9;
h13_9 = 0.5 *1e-9;
h13_10 = 0.5 *1e-9;
h13_11 = -0.4 *1e-9;
h13_12 = -0.4 *1e-9;
h13_13 = -0.6 *1e-9;
h = [h1_0 h2_0 h3_0 h4_0 h5_0 h6_0 h7_0 h8_0 h9_0 h10_0  h11_0  h12_0  h13_0;
     h1_1 h2_1 h3_1 h4_1 h5_1 h6_1 h7_1 h8_1 h9_1 h10_1  h11_1  h12_1  h13_1;
       0  h2_2 h3_2 h4_2 h5_2 h6_2 h7_2 h8_2 h9_2 h10_2  h11_2  h12_2  h13_2;
       0    0  h3_3 h4_3 h5_3 h6_3 h7_3 h8_3 h9_3 h10_3  h11_3  h12_3  h13_3;
       0    0    0  h4_4 h5_4 h6_4 h7_4 h8_4 h9_4 h10_4  h11_4  h12_4  h13_4;
       0    0    0    0  h5_5 h6_5 h7_5 h8_5 h9_5 h10_5  h11_5  h12_5  h13_5;
       0    0    0    0    0  h6_6 h7_6 h8_6 h9_6 h10_6  h11_6  h12_6  h13_6;
       0    0    0    0    0    0  h7_7 h8_7 h9_7 h10_7  h11_7  h12_7  h13_7;
       0    0    0    0    0    0    0  h8_8 h9_8 h10_8  h11_8  h12_8  h13_8;
       0    0    0    0    0    0    0    0  h9_9 h10_9  h11_9  h12_9  h13_9;
       0    0    0    0    0    0    0    0    0  h10_10 h11_10 h12_10 h13_10;
       0    0    0    0    0    0    0    0    0    0    h11_11 h12_11 h13_11;
       0    0    0    0    0    0    0    0    0    0       0   h12_12 h13_12;
       0    0    0    0    0    0    0    0    0    0       0      0   h13_13];

r_N = [859.52248524; -4541.5945528; 4380.34474178]
t =3500
alpha_G_0 = 0
n = 13
IGRF = earthmagfield(r_N, t, g, h, alpha_G_0, n)

function [B_N]  = earthmagfield(r_N, t, g, h, alpha_G_0, n)
%
% Earth Magnetic Field with Spherical Harmonics
%
%DESCRIPTION:
%This code computes the components of the Earth's Magnetic Field using
%spherical harmonics from order 1 until order 13.
%
%Gaussian Coefficients from IGRF 13th Gen. 2020 are transformed from the
%Schmidt Quasi-Normalization to Gaussian Normalization using recursive
%formulas [1].
%
%--------------------------------------------------------------------------
% INPUTS:
%   r_N        [3x1]       S/C Pos. (Inertial Frame) [km]
%   t          [1x1]       Day Time                  [sec]
%   g          [14x13]     Gauss Coff. g_nm Matrix   [T]
%   h          [14x13]     Gauss Coff. h_nm Matrix   [T]
%   alpha_G_0  [1x1]       Greenwich Init. Longitude [rad]
%   n          [1x1]       Order Desired             [-]
%--------------------------------------------------------------------------
% OUTPUTS:
%   B_N        [3x1]       Mag. Field Components     [T]
%--------------------------------------------------------------------------
%
%NOTES:
% - Matrices containing coefficients g_nm and h_nm are contained in script
%   called "IGRF13.m"
% - In order to define the Model Order (n) tke into account that the lower 
%   is the orbit altitude the higher has to be the Model Order, therefore:
%     n = 1: Dipole Model (accurate enough only for orbits with altitudes above 20000 Km)
%     n < 4: for medium altitude orbits
%     n > 4: for low altitude orbits
% - Magnetic Field components and spacecraft position are in Earth centered
%   inertial frame
% - The Gaussian Normalization enables to save up to 7% of computational
%   effort [1]
%{
%NOTES ABOUT CELESTIAL COORDINATES
%The whole script works with just the s/c position (given by r_N).
%The Wertz notation defines:
% - phi = Longitude from Greenwich Meridian
% - alpa_G = Greenwich Merdian Longitude (note that this angle is updated
%            while orbiting in order to take into account the Earth
%            rotation)
% - delta = Elevation (but it is named also Declination) and here, due to
%           the fact that we do not take into account the Earth oblateness,
%           it is also the Latitude
% - theta = Co-Elevation (or Co-Declination) (note that in the global model
%           this variable is used for True Anomaly, but here, for the only
%           reason of being in accordance with Wertz's notation, it has
%           been renamed
% - alpha = Right Ascension, it is the angle between the projection of the
%           s/c position on the Equatorial Plane and the Vernal Axis (which
%           we assume to be the x-axis of the Inertial Ref. Frame);
%}
%
%CALLED FUNCTIONS:
% (none)
%
%UPDATES:
% (none)
%
%REFERENCES:
% [1] James R. Wertz, "Spacecraft Attitude Determination and Control". 
%     Kluwer Academic Publishers, Spinger, 1993.
%
%AUTHOR(s):
%Luigi De Maria, 2020
%

%% Pre-Settings & Memory Allocation

%Matrix of Coefficients S_n,m
S_nm = zeros(n+1,n);
S_00 = 1;

%Matrix of Coefficients P^n,m
P_nm = zeros(n+1,n);
P_00 = 1;

%Matrix of Coefficients Derivatives d_P^n,m
d_P_nm = zeros(n+1,n);
d_P_00 = 0;

%Matrix of Coefficients K^n,m
K_nm = zeros(n+1,n);

%Matrix of Coefficients g_nm, h_nm
g_nm = zeros(n+1,n);
h_nm = zeros(n+1,n);

%% Topocentric Horizon Angles
z = r_N(3,1);
x = r_N(1,1);
y = r_N(2,1);
ab = norm(r_N);

%Earth Radius [km]
Re = 6371;

%Earth Angular Velocity [rad/sec]
om_E = 7.292124*1e-5;

%Elevation (or Declination) = Latitude (no J2 effect)
delta = asin(z/ab);

%Coelevation
theta = pi/2 - delta;

%Greenwich Meridian Longitude
alpha_G = alpha_G_0 + t * om_E;

%Right Ascension (Local Sidereal Time)
if (y/ab) > 0
    alpha = acos((x/ab)/cos(delta));
else
    alpha = 2*pi - acos((x/ab)/cos(delta));
end

%Longitude (from Greenwich)
phi = alpha - alpha_G;

%% Gauss Normalization

%Coefficients S_nm
%OBS i = m and j = n
%First Row (S_n,0)
for j = 1 : n
    if j == 1
        S_nm(1,j) = S_00 * ((2*j - 1)/j);
    elseif j >= 2
        S_nm(1,j) = S_nm(1,j-1)*((2*j - 1)/j);
    end
end
%Remaining Components (S_n,m)
for j = 1 : n
    for i = 2 : j+1
            S_nm(i,j) = S_nm(i-1,j)*sqrt(((kronDel(1,i-1) + 1)*(j - (i-1) + 1))...
                                    /(j + (i -1)));
    end
end

%Coefficients K^n,m
for j = 1 : n
    for i = 1 : j+1
        if j == 1
            K_nm(i,j) = 0;
        elseif j > 1
            K_nm(i,j) = ((j - 1)^2 - (i-1)^2) / ((2*j - 1)*(2*j - 3));
        end
    end
end

%Coefficients P^n,m
P_nm(1,1) = cos(theta)*P_00;        %P_1,0
P_nm(2,1) = sin(theta)*P_00;        %P_1,1
for j = 2 : n
    for i = 1 : j+1
        if i-1 == j                             %P_n,n
            P_nm(i,j) = sin(theta)*P_nm(j,j-1);
        else
            if j < 3                            %P_n,m
                P_nm(i,j) = cos(theta)*P_nm(i,j-1);
            else
                P_nm(i,j) = cos(theta)*P_nm(i,j-1) - K_nm(i,j)*P_nm(i,j-2);
            end
        end
    end
end

%Derivative of d_P^n,m (wrt theta)
d_P_nm(1,1) = cos(theta)*d_P_00 - sin(theta)*P_00; %d_P_1,0
d_P_nm(2,1) = sin(theta)*d_P_00 + cos(theta)*P_00; %d_P_1,1
for j = 2 : n
    for i = 1 : j+1
        if i-1 == j
            d_P_nm(i,j) = sin(theta)*d_P_nm(j,j-1) + cos(theta)*P_nm(j,j-1);
        else
            if j < 3
                d_P_nm(i,j) = cos(theta)*d_P_nm(i,j-1) - sin(theta)*P_nm(i,j-1);
            else
                d_P_nm(i,j) = cos(theta)*d_P_nm(i,j-1) - ...
                        sin(theta)*P_nm(i,j-1) - K_nm(i,j)*d_P_nm(i,j-2);
            end
        end
    end
end

%% Guassian Coefficients Normalization

for j = 1 : n
    for i = 1 : j+1
        g_nm(i,j) = S_nm(i,j)*g(i,j);
        h_nm(i,j) = S_nm(i,j)*h(i,j);
    end
end

%% Magnetic Field Components - Spherical Coordinates

%Reset Handle Variables
dx = 0;
pr = 0;
%Radial Component
for j = 1 : n
    sx = (Re/norm(r_N))^(j+2) * (j + 1);
    for i = 1 : j+1
        dx = dx + (g_nm(i,j)*cos((i-1)*phi) + h_nm(i,j)*sin((i-1)*phi)) * P_nm(i,j);
    end
    pr = pr + sx*dx;
    dx = 0;
end
B_r = pr;

%Reset Handle Variables
dx = 0;
pr = 0;
%Coelevation Component
for j = 1 : n
    sx = ((Re/norm(r_N))^(j+2));
    for i = 1 : j+1
        dx = dx + (g_nm(i,j)*cos((i-1)*phi) + h_nm(i,j)*sin((i-1)*phi)) * d_P_nm(i,j);
    end
    pr = pr + sx*dx;
    dx = 0;
end
B_th = -pr;


%Reset Handle Variables
dx = 0;
pr = 0;
%Azimuth Component
for j = 1 : n
    sx = ((Re/norm(r_N))^(j+2));
    for i = 1 : j+1
        dx = dx + (i*(-g_nm(i,j)*sin((i-1)*phi) + h_nm(i,j)*cos((i-1)*phi)) * P_nm(i,j));
    end
    pr = pr + sx*dx;
    dx = 0;
end
B_phi = -1/sin(theta) * pr;
disp([B_r; B_th; B_phi]);
%% Magnetic Field Components - Inertial Ref. Frame

B_1 = (B_r*cos(delta) + B_th*sin(delta))*cos(alpha) - B_phi*sin(alpha);
B_2 = (B_r*cos(delta) + B_th*sin(delta))*sin(alpha) + B_phi*cos(alpha);
B_3 = (B_r*sin(delta) - B_th*cos(delta));
B_N = [B_1; B_2; B_3];

end

%% Kronecker Delta Function
%
%Do to the unavailability of the function "kroneckerDelta" in Simulink, we
%had to implement it.
%
function d = kronDel(j,k)
if j == k
    d = 1;
else
    d = 0;
end
end